name: "Android Release"

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"
      - "nightly"

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  AWS_LC_SYS_PREBUILT_NASM: "1"
  ANDROID_NDK_VERSION: "29.0.13846066"

jobs:
  android_release_build:
    name: Android release build
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Android SDK and NDK
        run: |
          # Accept Android SDK licenses and update SDK first
          yes | ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager --licenses && yes | ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager --update
          
          # Install required SDK components
          ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager "platforms;android-33" "build-tools;34.0.0" "cmake;3.22.1" "ndk;${{ env.ANDROID_NDK_VERSION }}"
          
          # Set Android environment variables
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_NDK=$ANDROID_SDK_ROOT/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV

      - name: Install protobuf compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install Rust
        shell: bash
        run: |
          rustup update stable --no-self-update && rustup default stable
          rustup target add aarch64-linux-android

      - name: Setup Rust for Android
        run: |
          echo "[target.aarch64-linux-android]" >> ~/.cargo/config.toml
          echo "linker = \"$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang\"" >> ~/.cargo/config.toml
          echo "ar = \"$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar\"" >> ~/.cargo/config.toml

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Build Rust CLI for Android
        # Use --no-default-features to disable wasi feature
        run: cargo ndk -P 24 -t arm64-v8a build --bin fungi -r --no-default-features

      - name: Prepare Artifacts (Android)
        shell: bash
        run: |
          cp target/aarch64-linux-android/release/fungi libfungi.so
          tar -czf fungi-android-aarch64.tar.gz libfungi.so

      - name: GH publish
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.ref_name }}" = "nightly" ]; then
            RELEASE_TAG="nightly"
          else
            RELEASE_TAG="${{ github.ref_name }}"
          fi
          
          gh release upload -R ${{ github.repository }} --clobber $RELEASE_TAG fungi-android-aarch64.tar.gz
