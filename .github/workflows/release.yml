name: "Release"

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"
      - "nightly"

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  AWS_LC_SYS_PREBUILT_NASM: "1"

jobs:
  release_build_and_publish:
    name: Release build and publish
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - rust-target: x86_64-unknown-linux-gnu
            os: ubuntu-22.04
            platform-name: linux-x86_64
          - rust-target: aarch64-unknown-linux-gnu
            os: ubuntu-22.04
            cross: true
            platform-name: linux-aarch64
          - rust-target: aarch64-apple-darwin
            os: macos-latest
            platform-name: macos-aarch64
          - rust-target: x86_64-pc-windows-msvc
            os: windows-latest
            platform-name: windows-x86_64
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libayatana-appindicator3-dev protobuf-compiler

      - name: Install macOS dependencies
        if: matrix.os == 'macos-latest'
        run: |
          brew install protobuf

      - name: Install Windows dependencies (NASM)
        if: matrix.os == 'windows-latest'
        run: |
          choco install nasm protoc
          echo "C:\Program Files\NASM" >> $GITHUB_PATH
        shell: powershell

      - name: Install Rust
        shell: bash
        run: |
          rustup update stable --no-self-update && rustup default stable
          rustup target add ${{ matrix.rust-target }}

      - name: Install cross
        if: ${{ matrix.cross }}
        run: cargo install cross

      - name: Build Rust CLI
        shell: bash
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release --bin fungi --target ${{ matrix.rust-target }}
          else
            cargo build --release --bin fungi --target ${{ matrix.rust-target }}
          fi

      - name: Prepare Artifacts (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          # Use a dist directory to avoid conflict with the 'fungi' directory in the root
          mkdir -p dist
          cp target/${{ matrix.rust-target }}/release/fungi dist/fungi
          tar -czf fungi-${{ matrix.platform-name }}.tar.gz -C dist fungi

      - name: Prepare Artifacts (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          cp target/${{ matrix.rust-target }}/release/fungi.exe fungi.exe
          tar -czf fungi-${{ matrix.platform-name }}.tar.gz fungi.exe

      - name: Copy proto file
        if: matrix.platform-name == 'linux-x86_64'
        shell: bash
        run: |
          cp crates/daemon-grpc/proto/fungi_daemon.proto fungi_daemon.proto

      - name: GH publish
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.ref_name }}" = "nightly" ]; then
            RELEASE_TAG="nightly"
          else
            RELEASE_TAG="${{ github.ref_name }}"
          fi
          
          gh release upload -R ${{ github.repository }} --clobber $RELEASE_TAG fungi-${{ matrix.platform-name }}.tar.gz
          
          if [ -f fungi_daemon.proto ]; then
            gh release upload -R ${{ github.repository }} --clobber $RELEASE_TAG fungi_daemon.proto
          fi
